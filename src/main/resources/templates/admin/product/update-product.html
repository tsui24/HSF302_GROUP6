<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="author" content="Duong Quyen" />
    <title>Update Product</title>
    <link th:href="@{/css/styles.css}" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        /* Đảm bảo modal hiển thị trên cùng */
        .modal {
            display: none;
            position: fixed;
            z-index: 1100; /* Đặt z-index cao hơn sidebar và header */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        /* Điều chỉnh kích thước ảnh trong modal */
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1110; /* Đảm bảo ảnh nổi lên trên các phần khác */
        }

        /* Nút đóng modal */
        .close {
            position: absolute;
            top: 15px;
            right: 25px;
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1120;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .thumbnail:hover {
            transform: scale(2);
        }
        .thumbnail {
            width: 80px;
            height: 80px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .thumbnail:hover {
            transform: scale(1.1);
        }
        .button-container {
            display: flex;
            gap: 10px; /* Adjust the gap between buttons as needed */
            justify-content: flex-start; /* Aligns buttons to the left */
        }
    </style>
    <script>
        $(document).ready(() => {
            const avatarFile = $("#avatarFile");
            const orgImage = $("#avatarPreview").attr("data-src");
            if (orgImage) {
                $("#avatarPreview").attr("src", orgImage);
                $("#avatarPreview").css({ "display": "block" });
            }

            avatarFile.change(function (e) {
                const imgURL = URL.createObjectURL(e.target.files[0]);
                $("#avatarPreview").attr("src", imgURL);
                $("#avatarPreview").css({ "display": "block" });
            });
        });
    </script>
    <script th:inline="javascript">
        var existingNames = /*[[${nameList}]]*/ [];
        var pre_Names = /*[[${foodName}]]*/ "";
        var nameRegex = /^[a-zA-ZÀ-Ỹà-ỹ\s]+$/;
        var phoneRegex = /^[0-9]{10,11}$/;
        var moneyRegex = /^[0-9]+$/;
        var today = new Date().toISOString().split("T")[0];
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("profile-form");

            const productName = document.getElementById("productName");
            const price = document.getElementById("price");
            const shortDetail = document.getElementById("shortDetail");
            const detailDesc = document.getElementById("detailDesc");
            const storage = document.getElementById("storage");
            const category = document.getElementById("category");
            const avatarFile = document.getElementById("avatarFile");

            // Hàm tạo thông báo lỗi bên dưới input
            function showError(input, message) {
                let errorElement = input.nextElementSibling;

                if (!errorElement || !errorElement.classList.contains("error-message")) {
                    errorElement = document.createElement("p");
                    errorElement.classList.add("error-message");
                    errorElement.style.color = "red";
                    errorElement.style.fontWeight = "bold";
                    errorElement.style.marginTop = "5px";
                    input.parentNode.appendChild(errorElement);
                }

                errorElement.textContent = message;
            }

            // Hàm xóa thông báo lỗi
            function clearError(input) {
                let errorElement = input.nextElementSibling;
                if (errorElement && errorElement.classList.contains("error-message")) {
                    errorElement.remove();
                }
            }

            form.addEventListener("submit", function (event) {
                let hasError = false;

                // Kiểm tra name
                clearError(productName);
                if (productName.value.trim() === "") {
                    showError(productName, "Food Name is not empty");
                    hasError = true;
                } else if (!productName.value.match(nameRegex)) { // Kiểm tra ký tự đặc biệt & số
                    showError(productName, "Food Name must not contain numbers or special characters.");
                    hasError = true;
                } else if(existingNames.includes(productName.value) && (productName.value !== pre_Names)){
                    showError(productName, "Food Name is not duplicate.");
                    hasError = true;
                }

                // Kiểm tra price
                clearError(price);
                if (price.value.trim() === "") {
                    showError(price, "Price is required.");
                    hasError = true;
                } else if (!/^\d+(\.\d{1,2})?$/.test(price.value)) {
                    showError(price, "Price must be a valid number.");
                    hasError = true;
                }

                // Kiểm tra short description
                clearError(shortDetail);
                if (shortDetail.value.trim() === "") {
                    showError(shortDetail, "Short Description is required.");
                    hasError = true;
                }

                // Kiểm tra detail description
                clearError(detailDesc);
                if (detailDesc.value.trim() === "") {
                    showError(detailDesc, "Detail Description is required.");
                    hasError = true;
                }

                // Kiểm tra storage
                clearError(storage);
                if (storage.value.trim() === "") {
                    showError(storage, "Storage information is required.");
                    hasError = true;
                }

                // Kiểm tra category
                clearError(category);
                if (category.value.trim() === "") {
                    showError(category, "Category must be selected.");
                    hasError = true;
                }


                // Nếu có lỗi, ngăn form submit
                if (hasError) {
                    event.preventDefault();
                }
            });
        });
    </script>
</head>

<body class="sb-nav-fixed">
<!-- Header -->
<header th:replace="~{admin/layout/header :: header}"></header>

<div id="layoutSidenav">
    <!-- Sidebar -->
    <aside th:replace="~{admin/layout/sidebar :: sidebar}"></aside>

    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4">
                <h1 class="mt-4">Products</h1>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item"><a th:href="@{/product/list-product-admin}">Dashboard</a></li>
                    <li class="breadcrumb-item">Products</li>
                    <li class="breadcrumb-item active">Update</li>
                </ol>

                <div class="mt-5">
                    <div class="row">
                        <div class="col-md-6 col-12 mx-auto">
                            <h3>Update a product</h3>
                            <hr />

                            <form id="profile-form" th:action="@{/product/update}" method="POST" enctype="multipart/form-data" class="row">

                                <!-- Hidden ID -->
                                <input type="hidden" name ="productID" th:value="${product.id}" />

                                <!-- Name -->
                                <div class="mb-3 col-12 col-md-6">
                                    <label class="form-label">Name:</label>
                                    <input type="text" class="form-control" id="productName" name="productName" th:value="${product.name}" />
                                </div>

                                <!-- Price -->
                                <div class="mb-3 col-12 col-md-6">
                                    <label class="form-label">Price:</label>
                                    <input type="number" class="form-control" id="price" name="price" th:value="${product.price}" />
                                </div>

                                <!-- Detail Description -->
                                <div class="mb-3">
                                    <label class="form-label">Detail description:</label>
                                    <textarea class="form-control" id="detailDesc" name="detailDesc" rows="5"
                                              style="resize: vertical; width: 100%;" th:text="${product.detailDescription}"></textarea>
                                </div>

                                <!-- Short Description -->
                                <div class="mb-3 col-12 col-md-6">
                                    <label class="form-label">Short description:</label>
                                    <input type="text" class="form-control" id="shortDetail" name="shortDetail" th:value="${product.shortDescription}" />
                                </div>

                                <!-- Storage -->
                                <div class="mb-3 col-12 col-md-6">
                                    <label class="form-label">Storage:</label>
                                    <select class="form-select" id="storage"  name="storage">
                                        <option value="True" th:selected="${product.storage == 'True'}">In stock</option>
                                        <option value="False" th:selected="${product.storage == 'False'}">Out of stock</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Category:</label>
                                    <select class="form-select" name="category" id="category" >
                                        <option value="1" th:selected="${product.category.id == '1'}">Desserts</option>
                                        <option value="2" th:selected="${product.category.id == '2'}">Asian Dishes</option>
                                        <option value="3" th:selected="${product.category.id == '3'}">European Dishes</option>
                                        <option value="4" th:selected="${product.category.id == '4'}">Drinks</option>
                                        <option value="5" th:selected="${product.category.id == '5'}">Cakes</option>
                                    </select>
                                </div>
                                <div class="mb-3 col-12 col-md-6">
                                    <input type="hidden" id="oldImage" name="oldImage" th:value="${product.image}" />
                                    <label class="form-label">Image:</label>

                                    <!-- Ẩn input file mặc định -->
                                    <input type="file" id="avatarFile" accept=".png, .jpg, .jpeg" name="productFile" style="display: none;" />

                                    <!-- Nút tùy chỉnh để chọn ảnh -->
                                    <button type="button" class="btn btn-warning" onclick="document.getElementById('avatarFile').click();">
                                        Choose new image
                                    </button>

                                    <!-- Hiển thị ảnh preview -->
                                    <div class="mt-3">
                                        <img th:if="${product.image != null}"
                                             th:src="@{/product/image/{filename}(filename=${product.image})}"
                                             id="avatarPreview"
                                             style="max-width: 200px; max-height: 150px; object-fit: contain; border: 1px solid #ddd; border-radius: 5px; padding: 5px;"
                                             alt="Current Image" onclick="openImageModal(this.src)"/>
                                    </div>
                                </div>

                                <script>
                                    document.addEventListener("DOMContentLoaded", function () {
                                        const avatarFile = document.getElementById("avatarFile");
                                        const fileName = document.getElementById("fileName");
                                        const avatarPreview = document.getElementById("avatarPreview");

                                        avatarFile.addEventListener("change", function (event) {
                                            if (event.target.files.length > 0) {
                                                const imgURL = URL.createObjectURL(event.target.files[0]);
                                                avatarPreview.src = imgURL;
                                                avatarPreview.style.display = "block";

                                                // Hiển thị tên file đã chọn
                                                fileName.textContent = event.target.files[0].name;
                                            } else {
                                                fileName.textContent = "Chưa có ảnh nào được chọn";
                                            }
                                        });
                                    });
                                </script>
                                <!-- Submit Button -->
                                <div class="col-12 mb-5 button-container">
                                    <button type="submit" class="btn btn-warning">Update</button>
                                    <a th:href="@{/product/list-product-admin}" class="btn btn-success">Back</a>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer th:replace="~{admin/layout/footer :: footer}"></footer>
    </div>
</div>
<div id="imageModal" class="modal">
    <span class="close" onclick="closeImageModal()"> X </span>
    <img class="modal-content" id="modalImg">
</div>

<script>
    function openImageModal(src) {
        let modal = document.getElementById("imageModal");
        let modalImg = document.getElementById("modalImg");

        modal.style.display = "flex"; // Hiển thị modal
        modalImg.src = src;
        modalImg.style.maxWidth = "90vw"; // Đảm bảo không bị phóng đại quá mức
        modalImg.style.maxHeight = "90vh";
    }

    function closeImageModal() {
        document.getElementById("imageModal").style.display = "none";
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
<script th:src="@{/js/scripts.js}"></script>
</body>

</html>
